name: Tor Firefox over Cloudflare Tunnel (Dev Only)

on:
  workflow_dispatch:

env:
  VNC_PASSWD: vncpasswd
  NGINX_USER: torfirefox
  FIREFOX_PORT: 5900
  WEBPORT_NOVNC: 6080
  WEBPORT_PANEL: 6081
  TOR_SOCKS_PORT: 9050
  TOR_CONTROL_PORT: 9051
  # 匿名性を少し高めるために Tor Control 用パスワードもランダム化
  TOR_CONTROL_PASSWD_FILE: /tmp/tor-control.passwd

jobs:
  tor-firefox:
    runs-on: ubuntu-latest
    timeout-minutes: 360  # GitHub Actions 上の最大に近い値

    steps:
      - name: 1) Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            firefox \
            tor \
            websockify \
            novnc \
            nginx \
            openssl \
            netcat-openbsd \
            x11vnc \
            xvfb \
            xdotool

      - name: 2) Generate passwords
        id: pw
        run: |
          # ベーシック認証用パスワード（32文字）
          BASIC_PW=$(openssl rand -base32 32 | head -c 32)
          echo "BASIC_PW=${BASIC_PW}" >> $GITHUB_OUTPUT

          # Tor Control パスワード（16文字）
          TOR_PW=$(openssl rand -base32 16 | head -c 16)
          echo "TOR_CONTROL_PW=${TOR_PW}" >> $GITHUB_OUTPUT

          # Tor Control 用のハッシュ化パスワード生成（tor --hash-password）
          TOR_HASHED=$(tor --hash-password "${TOR_PW}" | head -n 1)
          echo "${TOR_PW}" > "${{ env.TOR_CONTROL_PASSWD_FILE }}"
          echo "TOR_CONTROL_HASHED=${TOR_HASHED}" >> $GITHUB_OUTPUT

          echo "============================================================"
          echo "Generated BASIC_PW:   ${BASIC_PW}"
          echo "Generated TOR_CONTROL_PW (raw): ${TOR_PW}"
          echo "Generated TOR_CONTROL_HASHED:   ${TOR_HASHED}"
          echo "============================================================"

      - name: 3) Prepare X11 virtual display
        run: |
          # Xvfb を仮想ディスプレイ :99 で起動
          Xvfb :99 -screen 0 1280x720x24 > /tmp/xvfb.log 2>&1 &
          echo "DISPLAY=:99" >> $GITHUB_ENV

      - name: 4) Configure Firefox profile (proxy & fingerprint protections)
        run: |
          # Firefox プロファイル作成
          mkdir -p ~/.mozilla/firefox/torfirefox
          PROFILE_INI=~/.mozilla/firefox/profiles.ini
          echo "[Profile0]" > "${PROFILE_INI}"
          echo "Name=torfirefox" >> "${PROFILE_INI}"
          echo "IsRelative=1" >> "${PROFILE_INI}"
          echo "Path=torfirefox" >> "${PROFILE_INI}"
          echo "Default=1" >> "${PROFILE_INI}"

          PROFILE_DIR=~/.mozilla/firefox/torfirefox
          # ユーザ設定を上書きする user.js
          cat > "${PROFILE_DIR}/user.js" << 'EOF'
          // Tor SOCKS5 プロキシ設定
          user_pref("network.proxy.type", 1);
          user_pref("network.proxy.socks", "127.0.0.1");
          user_pref("network.proxy.socks_port", 9050);
          user_pref("network.proxy.socks_version", 5);
          user_pref("network.proxy.socks_remote_dns", true);
          user_pref("network.proxy.no_proxies_on", "");

          // DNS over HTTPS を無効化して Tor 経由 DNS を優先
          user_pref("network.trr.mode", 5);

          // Firefox 指紋対策（RFP）【turn2search15】【turn0search16】
          user_pref("privacy.resistFingerprinting", true);
          user_pref("privacy.window.maxInnerWidth", 1366);
          user_pref("privacy.window.maxInnerHeight", 768);

          // OS 偽装（Windows っぽく）
          user_pref("general.useragent.override", "Mozilla/5.0 (Windows NT 10.0; rv:115.0) Gecko/20100101 Firefox/115.0");
          user_pref("general.platform.override", "Win32");
          user_pref("general.oscpu.override", "Windows NT 10.0; Win64; x64");

          // その他トラッキング軽減
          user_pref("privacy.trackingprotection.enabled", true);
          user_pref("privacy.trackingprotection.pbmode.enabled", true);

          // セッションと履歴
          user_pref("browser.sessionstore.resume_from_crash", false);
          user_pref("browser.startup.page", 0);

          // 不要な機能の無効化
          user_pref("media.peerconnection.enabled", false);
          user_pref("dom.webnotifications.enabled", false);
          user_pref("browser.cache.disk.enable", false);
          user_pref("browser.cache.memory.enable", true);
          EOF

      - name: 5) Configure Tor (SOCKS + Control)
        run: |
          TORRC=/etc/tor/torrc
          sudo cp "${TORRC}" "${TORRC}.bak"

          # SOCKS + Control Port + Control 認証
          sudo bash -c 'cat > "${TORRC}" << EOF
          SOCKSPort ${{ env.TOR_SOCKS_PORT }} IsolateDestAddr
          ControlPort ${{ env.TOR_CONTROL_PORT }}
          HashedControlPassword ${{ steps.pw.outputs.TOR_CONTROL_HASHED }}
          DataDirectory /var/lib/tor
          Log notice file /var/log/tor/log
          EOF
          '

          # ディレクトリ作成＆権限設定
          sudo mkdir -p /var/lib/tor /var/log/tor
          sudo chown -R debian-tor:debian-tor /var/lib/tor /var/log/tor

          # Tor サービス再起動
          sudo systemctl restart tor

          # Tor 起動待ち
          for i in {1..30}; do
            if nc -z 127.0.0.1 ${{ env.TOR_SOCKS_PORT }} 2>/dev/null; then
              echo "Tor SOCKS port is ready."
              break
            fi
            echo "Waiting for Tor SOCKS port ($i/30)..."
            sleep 2
          done

          # ログ出力
          sudo tail -n 30 /var/log/tor/log

      - name: 6) Start Firefox with Tor profile
        run: |
          # 仮想ディスプレイとプロファイルを指定して Firefox 起動
          firefox --profile ~/.mozilla/firefox/torfirefox \
            --display=:99 \
            > /tmp/firefox.log 2>&1 &

          # Firefox 起動待ち（ポートを直接見られないので、プロセスとプロファイルフォルダを監視）
          for i in {1..30}; do
            if pgrep -x firefox > /dev/null && [ -d ~/.mozilla/firefox/torfirefox ]; then
              echo "Firefox seems to be up."
              break
            fi
            echo "Waiting for Firefox ($i/30)..."
            sleep 2
          done

          # ログ
          cat /tmp/firefox.log

      - name: 7) Start x11vnc and websockify (noVNC)
        run: |
          # VNC パスワード設定
          x11vnc -storepasswd "${{ env.VNC_PASSWD }}" ~/.vnc/passwd

          # x11vnc 起動（:99 ディスプレイをポート ${{ env.FIREFOX_PORT }} で公開）
          x11vnc -display :99 -rfbport ${{ env.FIREFOX_PORT }} \
            -rfbauth ~/.vnc/passwd -forever -shared -nopw \
            > /tmp/x11vnc.log 2>&1 &

          # websockify 起動（noVNC から VNC へのブリッジ）
          websockify --web=/usr/share/novnc ${{ env.WEBPORT_NOVNC }} \
            127.0.0.1:${{ env.FIREFOX_PORT }} \
            > /tmp/websockify.log 2>&1 &

          echo "VNC and noVNC started."

      - name: 8) Setup Tor panel (simple HTTP server with auth)
        run: |
          PANEL_DIR=/tmp/tor-panel
          mkdir -p "${PANEL_DIR}"

          # パスワードとTor制御コマンドを実行する簡易 CGI
          cat > "${PANEL_DIR}/index.cgi" << 'CGI_EOF'
          #!/bin/bash
          echo "Content-Type: text/html; charset=utf-8"
          echo ""

          # Basic Auth は nginx 側でやる想定だが、念のため TOR_CONTROL_PW のチェックを入れる例
          export TOR_CONTROL_PASSWD_FILE=/tmp/tor-control.passwd
          TOR_CONTROL_PW=$(cat "${TOR_CONTROL_PASSWD_FILE}" 2>/dev/null)

          echo "<!doctype html>"
          echo "<html><head><title>Tor Panel</title></head><body>"
          echo "<h1>Tor 管理パネル</h1>"

          if [ -z "${TOR_CONTROL_PW}" ]; then
            echo "<p style='color:red'>Tor control password not found on server.</p>"
          else
            echo "<p>Tor Control password is set (not shown for safety).</p>"
          fi

          echo "<h2>Actions</h2>"

          # NEWNYM（回線切り替え）リクエストの処理
          QUERY_STRING="${QUERY_STRING:-}"
          if echo "${QUERY_STRING}" | grep -q 'action=newnym'; then
            if [ -n "${TOR_CONTROL_PW}" ]; then
              (
                sleep 0.2
                echo -e "AUTHENTICATE \"${TOR_CONTROL_PW}\"\r"
                sleep 0.2
                echo -e "SIGNAL NEWNYM\r"
                sleep 0.2
                echo -e "QUIT\r"
              ) | nc 127.0.0.1 9051 > /tmp/tor-newnym.log 2>&1

              echo "<p>NEWNYM を要求しました。結果:</p>"
              echo "<pre>"
              cat /tmp/tor-newnym.log
              echo "</pre>"
            else
              echo "<p style='color:red'>NEWNYM 失敗: Tor control password なし。</p>"
            fi
          fi

          echo "<ul>"
          echo "<li><a href=\"./index.cgi?action=newnym\">NEWNYM: 回線（サーキット）を切り替え</a></li>"
          echo "</ul>"

          echo "<h2>Tor ログ（最新30行）</h2>"
          echo "<pre>"
          sudo tail -n 30 /var/log/tor/log 2>/dev/null || echo "Log not available."
          echo "</pre>"

          echo "</body></html>"
          CGI_EOF

          chmod +x "${PANEL_DIR}/index.cgi"

          echo "Tor panel prepared at ${PANEL_DIR}"

      - name: 9) Configure nginx (Basic auth + reverse proxies)
        run: |
          # htpasswd 生成（apache2-utils が足りない場合は openssl でベタ生成）
          # ここでは openssl を使って簡易的に生成する例
          HTPASSWD_FILE=/etc/nginx/.htpasswd
          BASIC_PW="${{ steps.pw.outputs.BASIC_PW }}"
          # user:${openssl-md5-hash} 形式（簡易）
          # 本来は htpasswd -nb ユーザ パスワード 推奨だが、依増を減らすために自前生成
          HTPASSWD_ENTRY="${{ env.NGINX_USER }}:$(openssl passwd -apr1 "${BASIC_PW}")"
          echo "${HTPASSWD_ENTRY}" | sudo tee "${HTPASSWD_FILE}" > /dev/null

          # nginx 設定
          sudo bash -c 'cat > /etc/nginx/sites-available/default << EOF
          server {
              listen 80;
              server_name _;

              auth_basic "Tor Firefox Realm";
              auth_basic_user_file /etc/nginx/.htpasswd;

              # noVNC
              location / {
                  proxy_pass http://127.0.0.1:${{ env.WEBPORT_NOVNC }}/;
                  proxy_http_version 1.1;
                  proxy_set_header Upgrade \$http_upgrade;
                  proxy_set_header Connection "upgrade";
                  proxy_set_header Host \$host;
              }

              # Tor 管理パネル（CGI）
              location /tor-panel {
                  alias /tmp/tor-panel;
                  gzip off;
                  index index.cgi;

                  location ~ \.cgi$ {
                      include /etc/nginx/fastcgi_params;
                      fastcgi_pass unix:/var/run/fcgiwrap.socket;
                      fastcgi_param SCRIPT_FILENAME /tmp/tor-panel\$fastcgi_script_name;
                  }
              }
          }
          EOF
          '

          # fcgiwrap のインストール（CGI 実行用）
          sudo apt-get install -y fcgiwrap

          # 構文チェック＆再起動
          sudo nginx -t
          sudo systemctl restart nginx

      - name: 10) Start cloudflared (Quick Tunnel, no account)【turn0search10】【turn0search11】
        id: tunnel
        run: |
          # cloudflared のバイナリ取得
          curl -L -o cloudflared.deb "https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb"
          sudo dpkg -i cloudflared.deb || sudo apt-get -f install -y

          # Quick Tunnel（バックグラウンド実行）
          cloudflared tunnel --url http://127.0.0.1:80 \
            > /tmp/cloudflared.log 2>&1 &

          # URL 取得待ち（ログに https://〜.trycloudflare.com が出る）
          for i in {1..60}; do
            if grep -q "https://.*trycloudflare.com" /tmp/cloudflared.log; then
              TUNNEL_URL=$(grep -oP "https://[0-9a-zA-Z\-]+\.trycloudflare\.com" /tmp/cloudflared.log | head -n 1)
              if [ -n "${TUNNEL_URL}" ]; then
                echo "TUNNEL_URL=${TUNNEL_URL}" >> $GITHUB_OUTPUT
                echo "============================================================"
                echo "Cloudflare Tunnel URL: ${TUNNEL_URL}"
                echo "Basic auth user:       ${{ env.NGINX_USER }}"
                echo "Basic auth password:   ${{ steps.pw.outputs.BASIC_PW }}"
                echo "============================================================"
                break
              fi
            fi
            echo "Waiting for cloudflared tunnel URL ($i/60)..."
            sleep 2
          done

          # cloudflared ログ出力
          cat /tmp/cloudflared.log

      - name: 11) Keep alive and health check (Firefox + Tor)
        run: |
          # Firefox と Tor が生きているか監視しつつ、Action を落とさない
          END_TIME=$(($(date +%s) + 35000))  # 約 9.7 時間後（6時間制限ギリギリ前）
          echo "Will keep running until $(date -d @${END_TIME})."

          while [ "$(date +%s)" -lt "${END_TIME}" ]; do
            # Firefox プロセス監視
            if ! pgrep -x firefox > /dev/null; then
              echo "Firefox not running. Restarting..."
              firefox --profile ~/.mozilla/firefox/torfirefox \
                --display=:99 \
                > /tmp/firefox.log 2>&1 &
              sleep 5
            fi

            # Tor プロセス監視
            if ! pgrep -x tor > /dev/null; then
              echo "Tor not running. Trying to restart..."
              sudo systemctl restart tor
              sleep 5
            fi

            # SOCKS ポート疎通確認
            if ! nc -z 127.0.0.1 ${{ env.TOR_SOCKS_PORT }} 2>/dev/null; then
              echo "Tor SOCKS port not reachable. Check Tor logs:"
              sudo tail -n 20 /var/log/tor/log || true
            fi

            # 1分ごとに軽いログ出力（Action が kill されないように）
            echo "$(date '+%Y-%m-%d %H:%M:%S') - Firefox/Tor/cloudflared/nginx are running."

            sleep 60
          done

          echo "Reached max runtime limit. Exiting gracefully."
