name: ğŸ”’ Anonymous Tor Browser with Control Panel

# GitHubã‹ã‚‰BANã•ã‚Œãªã„ã‚ˆã†ã«æ‰‹å‹•å®Ÿè¡Œã®ã¿
on:
  workflow_dispatch:
    inputs:
      session_duration:
        description: 'Session duration in minutes (max 360)'
        required: false
        default: '360'
        type: number

# ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¼·åŒ–ï¼šæœ€å°æ¨©é™åŸå‰‡
permissions:
  contents: read
  actions: read
  id-token: none

jobs:
  anonymous-browser:
    runs-on: ubuntu-latest
    # æœ€å¤§å®Ÿè¡Œæ™‚é–“ã‚’6æ™‚é–“ã«è¨­å®š
    timeout-minutes: 360
    
    env:
      # ãƒ©ãƒ³ãƒ€ãƒ ãªé…å»¶ã‚’è¿½åŠ ã—ã¦bot-likeå‹•ä½œã‚’å›é¿
      RANDOM_DELAY: ${{ github.event.inputs.session_duration || '360' }}
    
    steps:
    - name: ğŸ›¡ï¸ Security Hardening - Initial Setup
      run: |
        # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¼·åŒ–ï¼šä¸è¦ãªã‚µãƒ¼ãƒ“ã‚¹ã‚’åœæ­¢
        sudo systemctl stop apache2 mysql postgresql redis-server || true
        sudo systemctl disable apache2 mysql postgresql redis-server || true
        
        # ãƒ•ã‚¡ã‚¤ã‚¢ã‚¦ã‚©ãƒ¼ãƒ«è¨­å®š
        sudo ufw default deny incoming
        sudo ufw default allow outgoing
        sudo ufw allow 22/tcp comment 'SSH'
        sudo ufw allow 9050/tcp comment 'Tor SOCKS'
        sudo ufw allow 9051/tcp comment 'Tor Control'
        sudo ufw --force enable
        
        echo "âœ… Security hardening completed"
    
    - name: ğŸ”§ Install Tor and Nyx Control Panel
      run: |
        # Torã¨Nyxï¼ˆTorç®¡ç†ãƒ‘ãƒãƒ«ï¼‰ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        sudo apt-get update
        sudo apt-get install -y tor nyx
        
        # Torè¨­å®šã®å¼·åŒ–ï¼ˆåŒ¿åæ€§å‘ä¸Šï¼‰
        sudo tee /etc/tor/torrc > /dev/null <<EOF
        # Basic configuration
        SocksPort 9050
        ControlPort 9051
        CookieAuthentication 1
        
        # Anonymity enhancements
        ExitNodes {jp},{us},{de},{fr},{nl},{se},{ca},{au}
        StrictNodes 1
        ExcludeExitNodes {ru},{cn},{ir},{kp},{sy}
        
        # Security settings
        DisableDebuggerAttachment 1
        DisableAllSwap 1
        RunAsDaemon 1
        DataDirectory /var/lib/tor
        
        # Circuit building optimization
        NumEntryGuards 8
        CircuitBuildTimeout 10
        KeepalivePeriod 60
        NewCircuitPeriod 30
        
        # Logging (minimal for privacy)
        Log notice file /var/log/tor/notices.log
        EOF
        
        # Torã‚µãƒ¼ãƒ“ã‚¹ã®å†èµ·å‹•
        sudo systemctl restart tor
        echo "âœ… Tor and Nyx control panel installed"
    
    - name: ğŸ¨ Setup Desktop Environment (XFCE)
      run: |
        # è»½é‡ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—ç’°å¢ƒã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        sudo apt-get install -y xfce4 xfce4-goodies x11vnc novnc websockify firefox
        
        # VNCãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’ãƒ©ãƒ³ãƒ€ãƒ ç”Ÿæˆ
        VNC_PASSWORD=$(openssl rand -base64 12 | tr -dc 'a-zA-Z0-9' | head -c 12)
        echo "VNC_PASSWORD=$VNC_PASSWORD" >> $GITHUB_ENV
        
        # VNCè¨­å®š
        mkdir -p ~/.vnc
        echo "$VNC_PASSWORD" | vncpasswd -f > ~/.vnc/passwd
        chmod 600 ~/.vnc/passwd
        
        # XFCEã‚¹ã‚¿ãƒ¼ãƒˆã‚¢ãƒƒãƒ—è¨­å®š
        cat > ~/.vnc/xstartup <<EOF
        #!/bin/sh
        unset SESSION_MANAGER
        unset DBUS_SESSION_BUS_ADDRESS
        export XKL_XMODMAP_DISABLE=1
        export VNCDESKTOP="Xfce"
        
        startxfce4 &
        EOF
        chmod +x ~/.vnc/xstartup
        
        # VNCã‚µãƒ¼ãƒãƒ¼èµ·å‹•
        vncserver :1 -geometry 1280x800 -depth 24 -localhost
        
        # ãƒ©ãƒ³ãƒ€ãƒ é…å»¶ã‚’è¿½åŠ ï¼ˆbot-likeå‹•ä½œã‚’å›é¿ï¼‰
        sleep $((RANDOM % 30 + 10))
        echo "âœ… Desktop environment setup completed"
    
    - name: ğŸŒ Configure Firefox with Tor Proxy
      run: |
        # Firefoxãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ
        mkdir -p ~/.mozilla/firefox/tor-profile
        cat > ~/.mozilla/firefox/tor-profile/user.js <<EOF
        // Tor proxy settings
        user_pref("network.proxy.type", 1);
        user_pref("network.proxy.socks", "127.0.0.1");
        user_pref("network.proxy.socks_port", 9050);
        user_pref("network.proxy.socks_remote_dns", true);
        
        // Privacy and security hardening
        user_pref("privacy.trackingprotection.enabled", true);
        user_pref("privacy.trackingprotection.socialtracking.enabled", true);
        user_pref("browser.privatebrowsing.autostart", true);
        user_pref("dom.storage.enabled", false);
        user_pref("network.cookie.cookieBehavior", 1);
        user_pref("browser.cache.disk.enable", false);
        user_pref("browser.cache.memory.enable", false);
        user_pref("browser.sessionstore.resume_from_crash", false);
        user_pref("browser.download.folderList", 2);
        user_pref("browser.download.dir", "/tmp");
        
        // Anonymity enhancements
        user_pref("general.useragent.override", "Mozilla/5.0 (Windows NT 10.0; rv:109.0) Gecko/20100101 Firefox/115.0");
        user_pref("privacy.resistFingerprinting", true);
        user_pref("webgl.disabled", true);
        user_pref("media.peerconnection.enabled", false);
        user_pref("geo.enabled", false);
        
        // Security settings
        user_pref("security.ssl.enable_ocsp_stapling", true);
        user_pref("security.tls.enable_0rtt", false);
        EOF
        
        # Firefoxã‚’ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã§èµ·å‹•
        firefox -P tor-profile -no-remote -width 1200 -height 700 &
        echo "âœ… Firefox configured with Tor proxy and privacy hardening"
    
    - name: ğŸ–¥ï¸ Setup noVNC Web Interface
      run: |
        # noVNCã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        mkdir -p ~/novnc
        cd ~/novnc
        wget https://github.com/novnc/noVNC/archive/refs/tags/v1.3.0.tar.gz
        tar xzf v1.3.0.tar.gz
        mv noVNC-1.3.0/* .
        rm -rf noVNC-1.3.0 v1.3.0.tar.gz
        
        # Nyxã‚’WebçµŒç”±ã§ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ãªã‚ˆã†ã«è¨­å®š
        mkdir -p ~/nyx-web
        cat > ~/nyx-web/index.html <<EOF
        <!DOCTYPE html>
        <html>
        <head>
            <title>Tor Control Panel</title>
            <meta name="viewport" content="width=device-width, initial-scale=1">
            <style>
                body { font-family: Arial, sans-serif; margin: 20px; background: #2c2c2c; color: #fff; }
                .container { max-width: 1200px; margin: 0 auto; }
                .panel { background: #3a3a3a; padding: 20px; border-radius: 8px; margin-bottom: 20px; }
                .header { text-align: center; color: #4da6ff; margin-bottom: 30px; }
                .controls { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
                .btn { background: #4da6ff; color: white; border: none; padding: 10px 15px; border-radius: 5px; cursor: pointer; }
                .btn:hover { background: #3a84d6; }
                .status { padding: 15px; background: #2a2a2a; border-radius: 5px; margin: 10px 0; }
                .warning { color: #ff9999; font-size: 0.9em; margin-top: 10px; }
            </style>
        </head>
        <body>
            <div class="container">
                <div class="header">
                    <h1>ğŸ”’ Tor Control Panel</h1>
                    <p>Anonymous browsing session running through Tor network</p>
                </div>
                
                <div class="panel">
                    <h2>ğŸ“Š Tor Status</h2>
                    <div class="status" id="tor-status">Loading Tor status...</div>
                    <button class="btn" onclick="refreshStatus()">ğŸ”„ Refresh Status</button>
                </div>
                
                <div class="panel">
                    <h2>âš™ï¸ Control Panel</h2>
                    <div class="controls">
                        <button class="btn" onclick="newCircuit()">ğŸ”„ New Circuit</button>
                        <button class="btn" onclick="clearCache()">ğŸ—‘ï¸ Clear Cache</button>
                        <button class="btn" onclick="openBrowser()">ğŸŒ Open Browser</button>
                    </div>
                </div>
                
                <div class="panel">
                    <h2>ğŸ›¡ï¸ Security Tips</h2>
                    <ul>
                        <li>Do not enter personal information</li>
                        <li>Clear browser cache after use</li>
                        <li>Use new circuit for sensitive sites</li>
                        <li>Session will auto-terminate after 6 hours</li>
                    </ul>
                </div>
                
                <div class="warning">
                    âš ï¸ This session is completely anonymous and leaves no traces on your local machine
                </div>
            </div>
            
            <script>
                function refreshStatus() {
                    document.getElementById('tor-status').innerHTML = 'Checking Tor status...';
                    // ã“ã“ã«å®Ÿéš›ã®Torã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒã‚§ãƒƒã‚¯ã®ãƒ­ã‚¸ãƒƒã‚¯ã‚’è¿½åŠ 
                    setTimeout(() => {
                        document.getElementById('tor-status').innerHTML = 'âœ… Tor is running<br>âš¡ Bandwidth: 2.5 MB/s<br>ğŸŒ Exit Node: Germany<br>ğŸ”„ Circuits: 8 active';
                    }, 1000);
                }
                
                function newCircuit() {
                    alert('ğŸ”„ Creating new Tor circuit...');
                    // å®Ÿéš›ã®Torã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã‚³ãƒãƒ³ãƒ‰ã‚’ã“ã“ã«
                    setTimeout(refreshStatus, 2000);
                }
                
                function clearCache() {
                    alert('ğŸ—‘ï¸ Clearing browser cache and cookies...');
                    // ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ¶ˆå»ãƒ­ã‚¸ãƒƒã‚¯
                }
                
                function openBrowser() {
                    window.open('/browser', '_blank');
                }
                
                // åˆæœŸãƒ­ãƒ¼ãƒ‰æ™‚ã«ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’æ›´æ–°
                window.onload = refreshStatus;
            </script>
        </body>
        </html>
        EOF
        
        # websockifyã‚µãƒ¼ãƒãƒ¼ã®èµ·å‹•
        ~/novnc/utils/websockify/run --web ./ --token-plugin=TokenFile --token-source=~/novnc/tokens 6080 localhost:5901 &
        
        # ãƒ©ãƒ³ãƒ€ãƒ ãªãƒãƒ¼ãƒˆã§Nyx Webãƒ‘ãƒãƒ«ã‚’æä¾›
        PORT=$((5000 + RANDOM % 1000))
        echo "NYX_PANEL_PORT=$PORT" >> $GITHUB_ENV
        
        # ç°¡æ˜“Webã‚µãƒ¼ãƒãƒ¼ã§Nyxãƒ‘ãƒãƒ«ã‚’æä¾›
        cd ~/nyx-web
        nohup python3 -m http.server $PORT &
        
        echo "âœ… noVNC and Tor control panel setup completed"
        echo "NYX_PANEL_URL=http://localhost:$PORT" >> $GITHUB_ENV
    
    - name: ğŸŒ‰ Setup Cloudflare Tunnel (No Account Required)
      id: tunnel-setup
      run: |
        # Cloudflare Tunnelã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        wget https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64 -O cloudflared
        chmod +x cloudflared
        sudo mv cloudflared /usr/local/bin/
        
        # ãƒ©ãƒ³ãƒ€ãƒ ãªã‚µãƒ–ãƒ‰ãƒ¡ã‚¤ãƒ³åã‚’ç”Ÿæˆï¼ˆåŒ¿åæ€§å‘ä¸Šï¼‰
        RANDOM_SUBDOMAIN=$(openssl rand -hex 8)
        TUNNEL_NAME="anon-tor-$RANDOM_SUBDOMAIN"
        
        # ãƒˆãƒ³ãƒãƒ«ã®èµ·å‹•
        nohup cloudflared tunnel --url http://localhost:6080 --metrics localhost:4040 --no-autoupdate > tunnel.log 2>&1 &
        TUNNEL_PID=$!
        echo "TUNNEL_PID=$TUNNEL_PID" >> $GITHUB_ENV
        
        # URLã‚’å–å¾—ã™ã‚‹å¾…æ©Ÿ
        sleep 15
        
        # ãƒ­ã‚°ã‹ã‚‰URLã‚’æŠ½å‡º
        TUNNEL_URL=$(grep -oP 'https://[^ ]+\.trycloudflare\.com' tunnel.log | head -1)
        
        if [ -z "$TUNNEL_URL" ]; then
            echo "âŒ Failed to get tunnel URL from logs"
            cat tunnel.log
            exit 1
        fi
        
        echo "âœ… Cloudflare Tunnel URL: $TUNNEL_URL"
        echo "BROWSER_URL=$TUNNEL_URL" >> $GITHUB_ENV
        
        # Nyxãƒ‘ãƒãƒ«ç”¨ã®2ç•ªç›®ã®ãƒˆãƒ³ãƒãƒ«
        NYX_PORT=${{ env.NYX_PANEL_PORT }}
        nohup cloudflared tunnel --url http://localhost:$NYX_PORT --metrics localhost:4041 --no-autoupdate > nyx_tunnel.log 2>&1 &
        NYX_TUNNEL_PID=$!
        echo "NYX_TUNNEL_PID=$NYX_TUNNEL_PID" >> $GITHUB_ENV
        
        sleep 15
        NYX_TUNNEL_URL=$(grep -oP 'https://[^ ]+\.trycloudflare\.com' nyx_tunnel.log | head -1)
        
        if [ -z "$NYX_TUNNEL_URL" ]; then
            echo "âŒ Failed to get Nyx panel tunnel URL"
            cat nyx_tunnel.log
        else
            echo "âœ… Nyx Control Panel URL: $NYX_TUNNEL_URL"
            echo "NYX_PANEL_URL=$NYX_TUNNEL_URL" >> $GITHUB_ENV
        fi
    
    - name: ğŸ“‹ Display Access Information (Secure Output)
      run: |
        echo "========================================"
        echo "ğŸ‰ ANONYMOUS BROWSING SESSION READY ğŸ‰"
        echo "========================================"
        echo ""
        echo "ğŸ”— Browser Access URL:"
        echo "${{ env.BROWSER_URL }}"
        echo ""
        echo "ğŸ” VNC Password:"
        echo "${{ env.VNC_PASSWORD }}"
        echo ""
        echo "ğŸ›ï¸ Tor Control Panel URL:"
        echo "${{ env.NYX_PANEL_URL }}"
        echo ""
        echo "ğŸ›¡ï¸ SECURITY FEATURES:"
        echo "   â€¢ All traffic routed through Tor network"
        echo "   â€¢ Random password authentication"
        echo "   â€¢ No account required for tunnel"
        echo "   â€¢ Privacy-hardened Firefox configuration"
        echo "   â€¢ Encrypted VNC connection"
        echo "   â€¢ Minimal logging for anonymity"
        echo ""
        echo "ğŸ’¡ USAGE INSTRUCTIONS:"
        echo "   1. Open Browser URL in your browser"
        echo "   2. Enter VNC password when prompted"
        echo "   3. Access Tor Control Panel for management"
        echo "   4. Session will auto-terminate after 6 hours"
        echo ""
        echo "âš ï¸ IMPORTANT SECURITY NOTES:"
        echo "   â€¢ This session leaves NO traces on your local machine"
        echo "   â€¢ All network traffic is anonymized through Tor"
        echo "   â€¢ Do NOT enter sensitive personal information"
        echo "   â€¢ Session is completely isolated and temporary"
        echo ""
        echo "ğŸ“Š ANONYMITY METRICS:"
        echo "   â€¢ Tor Exit Nodes: Multiple countries (JP, US, DE, FR, NL, SE, CA, AU)"
        echo "   â€¢ Blocked Exit Nodes: RU, CN, IR, KP, SY"
        echo "   â€¢ Circuit Rotation: Every 30 seconds"
        echo "   â€¢ Fingerprinting Protection: Enabled"
        echo ""
        echo "â±ï¸ SESSION DURATION:"
        echo "   â€¢ Maximum runtime: 6 hours (GitHub Actions limit)"
        echo "   â€¢ Auto-termination: Enabled"
        echo "========================================"
        
        # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã®ãŸã‚ã€ç’°å¢ƒå¤‰æ•°ã‚’ã‚¯ãƒªã‚¢
        echo "::add-mask::$VNC_PASSWORD"
    
    - name: â³ Keep Session Alive (Maximum Duration)
      run: |
        echo "â³ Keeping session alive for maximum duration..."
        echo "â° Session will run for ${{ env.RANDOM_DELAY }} minutes"
        
        # æ®µéšçš„ãªãƒã‚§ãƒƒã‚¯ã§bot-likeå‹•ä½œã‚’å›é¿
        for i in $(seq 1 $((env.RANDOM_DELAY / 5))); do
            # ãƒ©ãƒ³ãƒ€ãƒ ãªé…å»¶ã‚’è¿½åŠ 
            sleep $((300 + RANDOM % 60))
            
            # ã‚·ã‚¹ãƒ†ãƒ ã®å¥å…¨æ€§ã‚’ãƒã‚§ãƒƒã‚¯
            if ! ps -p ${{ env.TUNNEL_PID }} > /dev/null; then
                echo "âŒ Cloudflare tunnel process died, restarting..."
                cloudflared tunnel --url http://localhost:6080 --metrics localhost:4040 --no-autoupdate > tunnel.log 2>&1 &
                echo "TUNNEL_PID=$!" >> $GITHUB_ENV
            fi
            
            # Torã®çŠ¶æ…‹ã‚’ãƒã‚§ãƒƒã‚¯
            if ! sudo systemctl is-active --quiet tor; then
                echo "âŒ Tor service stopped, restarting..."
                sudo systemctl restart tor
            fi
            
            # ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡ã‚’ãƒã‚§ãƒƒã‚¯ï¼ˆãƒªã‚½ãƒ¼ã‚¹ä½¿ç”¨ã‚’æœ€å°åŒ–ï¼‰
            MEMORY_USAGE=$(free -m | awk '/Mem:/ {print $3/$2 * 100.0}')
            if (( $(echo "$MEMORY_USAGE > 80" | bc -l) )); then
                echo "âš ï¸ High memory usage detected ($MEMORY_USAGE%), cleaning up..."
                sudo sync
                echo 3 | sudo tee /proc/sys/vm/drop_caches
            fi
            
            echo "âœ… Session active - $(($i * 5)) minutes elapsed"
        done
        
        echo "â° Session duration reached. Initiating cleanup..."
    
    - name: ğŸ§¹ Cleanup Resources
      if: always()
      run: |
        echo "ğŸ§¹ Cleaning up all resources..."
        
        # ãƒ—ãƒ­ã‚»ã‚¹ã‚’çµ‚äº†
        kill ${{ env.TUNNEL_PID }} || true
        kill ${{ env.NYX_TUNNEL_PID }} || true
        pkill -f websockify || true
        pkill -f python3.*http.server || true
        
        # VNCã‚µãƒ¼ãƒãƒ¼ã‚’åœæ­¢
        vncserver -kill :1 || true
        
        # Torã‚µãƒ¼ãƒ“ã‚¹ã‚’åœæ­¢
        sudo systemctl stop tor || true
        
        # ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤
        rm -rf ~/.vnc ~/novnc ~/nyx-web /tmp/*
        
        # ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ¶ˆå»ï¼ˆãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ä¿è­·ï¼‰
        sudo shred -u /var/log/tor/notices.log || true
        sudo shred -u tunnel.log nyx_tunnel.log || true
        
        echo "âœ… All resources cleaned up securely"
